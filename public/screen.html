<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>گیرنده تصویر - پراکنده</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{background:#0b1324;margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#eee;}
header{margin:1rem;display:flex;gap:1rem;}
canvas{display:block;border:2px solid #333;border-radius:12px;width:400px;height:400px;}
.progress{width:100%;max-width:400px;height:10px;background:#222;border-radius:999px;overflow:hidden;margin-top:1rem;}
.bar{height:100%;width:0%;background:#22c55e;}
</style>
</head>
<body>
<header>
<label style="background:#22c55e;color:#000;padding:.5rem 1rem;border-radius:8px;cursor:pointer">
انتخاب تصویر<input id="file" type="file" accept="image/*" hidden>
</label>
<button id="resetBtn">شروع دوباره</button>
<span id="stat">0/0</span>
</header>

<div style="position:relative">
<canvas id="imgCanvas" width="400" height="400"></canvas>
<canvas id="maskCanvas" width="400" height="400" style="position:absolute;top:0;left:0;"></canvas>
</div>
<div class="progress"><div class="bar" id="bar"></div></div>

<script>
const socket = io();
const imgCanvas = document.getElementById("imgCanvas");
const maskCanvas = document.getElementById("maskCanvas");
const imgCtx = imgCanvas.getContext("2d");
const maskCtx = maskCanvas.getContext("2d");
const fileInput = document.getElementById("file");
const resetBtn = document.getElementById("resetBtn");
const statEl = document.getElementById("stat");
const barEl = document.getElementById("bar");

let cols=20, rows=20, TOTAL=cols*rows, revealed=0, order=[], tiles=[];

// ساخت بلوک‌ها
function computeTiles(){
  tiles=[];
  const cw = imgCanvas.width/cols;
  const ch = imgCanvas.height/rows;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      tiles.push({x:c*cw, y:r*ch, w:cw, h:ch});
    }
  }
}

// پر کردن ماسک
function fillMask(){
  maskCtx.fillStyle="#fff";
  maskCtx.fillRect(0,0,maskCanvas.width, maskCanvas.height);
}

// حذف بلوک مشخص
function revealIndex(i){
  const t=tiles[i];
  if(!t) return;
  maskCtx.clearRect(t.x,t.y,t.w,t.h);
}

// آپدیت پروگرس
function setProgress(){
  statEl.textContent = `${revealed}/${TOTAL}`;
  barEl.style.width = (revealed/TOTAL*100)+"%";
}

// دریافت وضعیت اولیه
socket.on("init", ({cols:c, rows:r, order:ord, revealed:rev, image, total})=>{
  cols=c; rows=r; TOTAL=total; revealed=rev;
  computeTiles();
  fillMask();
  if(image) drawImage(image);

  // آرایه order پراکنده
  order = Array.from({length: TOTAL}, (_, i)=>i);
  for(let i=order.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [order[i], order[j]] = [order[j], order[i]];
  }

  for(let k=0;k<revealed;k++) revealIndex(order[k]);
  setProgress();
});

// وقتی بلوک آشکار می‌شود
socket.on("reveal", ({revealed:rev})=>{
  revealed=rev;
  const idx = order[revealed-1];
  revealIndex(idx);
  setProgress();
});

// ریست کردن
socket.on("reset", ({order:ord})=>{
  revealed=0;
  fillMask();
  order = Array.from({length: TOTAL}, (_, i)=>i);
  for(let i=order.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [order[i], order[j]] = [order[j], order[i]];
  }
  setProgress();
});

// دریافت تصویر جدید
socket.on("image", ({image})=>{
  drawImage(image);
});

// انتخاب تصویر توسط کاربر
fileInput.onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    drawImage(reader.result);
    const img = new Image();
    img.onload = ()=>{
      imgCanvas.width = maskCanvas.width = img.width;
      imgCanvas.height = maskCanvas.height = img.height;
      const blockSize=20;
      cols = Math.ceil(img.width/blockSize);
      rows = Math.ceil(img.height/blockSize);
      TOTAL = cols*rows;
      computeTiles();
      fillMask();
      revealed=0;

      // آرایه order پراکنده
      order=[];
      for(let i=0;i<TOTAL;i++) order.push(i);
      for(let i=order.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [order[i], order[j]] = [order[j], order[i]];
      }

      socket.emit("setSize",{c:cols,r:rows});
      socket.emit("setImage", reader.result);
      setProgress();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
};

// ریست با دکمه
resetBtn.onclick = ()=> socket.emit("reset");

// رسم تصویر روی canvas
function drawImage(dataUrl){
  const img = new Image();
  img.onload = ()=>{
    imgCtx.clearRect(0,0,imgCanvas.width,imgCanvas.height);
    imgCtx.drawImage(img,0,0,imgCanvas.width,imgCanvas.height);
  };
  img.src = dataUrl;
}

// درخواست وضعیت اولیه
socket.emit("getState");
fillMask(); setProgress();
</script>
</body>
</html>
